<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CineMax Cajero</title>

    <!-- Estilos -->
    <link rel="stylesheet" href="../usuarios/usuarios.css" />
    <!-- √çconos de Phosphor (para los sillones y otros) -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
  </head>

  <body>
    <div class="container">
      <!-- ======================================================
         üî¥ SIDEBAR
    ====================================================== -->
      <aside class="sidebar">
        <h2 class="logo">CineMax Cajero</h2>
        <nav class="menu">
          <button
            class="menu-btn active"
            onclick="window.location.href='cajeros.html'"
          >
            <i class="ph ph-film-reel"></i> Ver Cartelera
          </button>

          <button
            class="menu-btn"
            onclick="window.location.href='cajeros-reservas.html'"
          >
            <i class="ph ph-ticket"></i> Reservas
          </button>

          <button
            class="menu-btn"
            onclick="window.location.href='consolidado.html'"
          >
            <i class="ph ph-chart-bar"></i> Consolidado
          </button>
        </nav>
      </aside>

      <!-- ======================================================
         üü¢ CONTENEDOR PRINCIPAL
    ====================================================== -->
      <main class="main-content">
        <!-- ======================================
           üîπ HEADER FIJO
      ====================================== -->
        <header class="header">
          <span>Bienvenido, Cajero user</span>
          <button class="logout-btn">
            <i class="ph ph-sign-out"></i> Cerrar sesi√≥n
          </button>
        </header>

        <!-- ======================================
           üé¨ CARTELERA
      ====================================== -->
        <section class="cartelera" id="seccionCartelera">
          <h2>Cartelera</h2>
          <div class="peliculas" id="listaPeliculas"></div>
        </section>

        <!-- ======================================
           üéüÔ∏è VENDER BOLETOS
      ====================================== -->
        <section class="vender oculto" id="seccionVender">
          <div class="detalle">
            <div class="tarjeta-pelicula">
              <img id="imgPelicula" src="" alt="Poster" />
              <div class="info-pelicula">
                <h3 id="tituloPelicula"></h3>
                <div class="subinfo">
                  <p class="genero">Acci√≥n</p>
                  <p class="duracion">2h 15min</p>
                  <span class="estrella">‚≠ê 4.5</span>
                </div>
              </div>
            </div>
          </div>

          <div class="opciones">
            <!-- Bloque FECHA -->
            <div class="bloque">
              <div class="bloque-titulo">
                <i class="ph ph-calendar"></i>
                <h4>Seleccionar Fecha</h4>
              </div>
              <div class="grupo-fechas">
                <button class="fecha">Jue<br /><span>Hoy</span></button>
                <button class="fecha activa">
                  Vie<br /><span>Ma√±ana</span>
                </button>
                <button class="fecha">S√°b<br /><span>24 Ago</span></button>
                <button class="fecha">Dom<br /><span>25 Ago</span></button>
                <button class="fecha">Lun<br /><span>26 Ago</span></button>
              </div>
            </div>

            <!-- Bloque FORMATO Y HORARIO -->
            <div class="bloque">
              <div class="bloque-titulo">
                <i class="ph ph-clock"></i>
                <h4>Seleccionar Formato y horario</h4>
              </div>
              <div class="barra-formato">
                <button class="formato activo">2D</button>
                <button class="formato">3D</button>
                <button class="formato">IMAX</button>
              </div>

              <p class="subtitulo">2D - Funci√≥n Regular</p>

              <div class="grupo-horas">
                <button class="hora">14:00</button>
                <button class="hora activa">16:30</button>
                <button class="hora">19:00</button>
                <button class="hora">21:30</button>
              </div>
            </div>

            <!-- Botones finales -->
            <div class="acciones">
              <button id="btnVolver" class="volver">
                <i class="ph ph-arrow-left"></i> Volver
              </button>
              <button class="continuar">Seleccionar Asientos</button>
            </div>
          </div>
        </section>

        <!-- ======================================
           ü™ë SELECCIONAR ASIENTOS
      ====================================== -->
        <section class="asientos oculto" id="seccionAsientos">
          <div class="encabezado-asientos">
            <button id="btnVolverAsientos" class="volver">
              <i class="ph ph-arrow-left"></i>
            </button>
            <h3 id="tituloAsientos">DEMON SLAYER: KIMETSU NO YAIBA</h3>
          </div>

          <div class="contenido-asientos">
            <!-- ü™ë MAPA DE ASIENTOS -->
            <div class="mapa-asientos">
              <div class="leyenda">
                <span
                  ><i class="ph ph-armchair disponible"></i> Disponible</span
                >
                <span
                  ><i class="ph ph-armchair seleccionado"></i>
                  Seleccionado</span
                >
                <span><i class="ph ph-armchair ocupado"></i> Ocupado</span>
                <span><i class="ph ph-armchair vip"></i> VIP ($25)</span>
                <span
                  ><i class="ph ph-armchair premium"></i> Premium ($18)</span
                >
              </div>

              <div class="pantalla"></div>
              <p class="etiqueta-pantalla">PANTALLA</p>

              <div class="grid-asientos" id="gridAsientos"></div>
            </div>

            <!-- üìã PANEL DE RESUMEN -->
            <div class="resumen">
              <h4>Resumen</h4>
              <p>
                <strong>Pel√≠cula:</strong><br /><span id="resumenPelicula"
                  >-</span
                >
              </p>
              <p>
                <strong>Funci√≥n:</strong><br /><span id="resumenFuncion"
                  >Ma√±ana ¬∑ 16:30 - 2D</span
                >
              </p>
              <p>
                <strong>Ubicaci√≥n:</strong><br /><span id="resumenUbicacion"
                  >CineMax Plaza Norte</span
                >
              </p>
              <p>
                <strong>Asientos:</strong><br /><span id="resumenAsientos"
                  >Ninguno</span
                >
              </p>
              <hr />
              <p><strong>Total $</strong><span id="resumenTotal">0</span></p>
              <div class="acciones-finales">
                <button class="continuar" id="btnConfirmarVenta">Vender</button>
                <button class="volver" id="btnReservar">Reservar</button>
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>

    <!-- ======================================================
     üí¨ MODAL DE DATOS DEL CLIENTE Y PAGO
====================================================== -->
    <div id="modalCliente" class="modal oculto">
      <div class="modal-content">
        <h3>Datos del Cliente</h3>
        <form id="formCliente">
          <label>üë§ Nombre completo</label>
          <input
            type="text"
            id="nombreCliente"
            required
            placeholder="Ej: Juan P√©rez"
          />

          <label>ü™™ C√©dula</label>
          <input
            type="text"
            id="cedulaCliente"
            required
            placeholder="Ej: 1234567890"
          />

          <label>üìû Tel√©fono</label>
          <input
            type="text"
            id="telefonoCliente"
            required
            placeholder="Ej: 3001234567"
          />

          <div id="bloquePago">
            <label>üí∞ Total a pagar</label>
            <input type="number" id="totalPagar" readonly />

            <label>üíµ Efectivo recibido</label>
            <input
              type="number"
              id="montoRecibido"
              placeholder="Monto entregado"
            />

            <label>üîÅ Cambio a entregar</label>
            <input type="text" id="cambioCliente" readonly value="$0" />
          </div>

          <div class="acciones-modal">
            <button type="button" id="btnCancelarModal">Cancelar</button>
            <button type="submit" id="btnConfirmarModal">Confirmar</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="../../shared/animaciones.js"></script>
    <script src="../../shared/logout.js"></script>
  </body>
</html>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  const contenedor = document.getElementById("listaPeliculas");

  try {
    const res = await fetch("https://cinemax-backend-production.up.railway.app/peliculas");
    const peliculas = await res.json();

    // Guardar cache globalmente para fallback cuando el endpoint por id no responda
    window.peliculasCache = Array.isArray(peliculas) ? peliculas : [];

    if (!Array.isArray(peliculas)) return;

    peliculas.forEach(p => {
      const div = document.createElement("div");
      div.className = "pelicula";

      // Horarios (quemados por ahora, luego los hacemos din√°micos)
      const horarios = `
        <div class="horarios">
          <span>14:30</span><span>17:00</span>
          <span>19:30</span><span>22:00</span>
        </div>
      `;

      div.innerHTML = `
        <img src="${p.poster}" alt="${p.titulo}">
        <h3>${p.titulo}</h3>
        <p class="genero">${p.genero}</p>
        <p class="duracion">${p.duracion}</p>
        ${horarios}
        <button class="btn-vender" data-id="${p._id}">Vender Boletos</button>
      `;

      contenedor.appendChild(div);
    });

    // Activar los botones de vender
    activarBotones();

  } catch (err) {
    console.error("‚ùå Error cargando cartelera:", err);
  }
});

function activarBotones() {
  document.querySelectorAll(".btn-vender").forEach(btn => {
    btn.addEventListener("click", (e) => {
      const id = e.target.dataset.id;
      abrirVenta(id);
    });
  });
}

// Guarda la pel√≠cula actualmente seleccionada
let peliculaActual = null;

async function abrirVenta(id) {
  try {
    const url = `https://cinemax-backend-production.up.railway.app/peliculas/${id}`;
    const res = await fetch(url);
    let p;
    if (res.ok) {
      p = await res.json();
    } else {
      // Intentar usar la cach√© local si el endpoint por id no est√° disponible
      console.warn(`Endpoint /peliculas/${id} devolvi√≥ estado ${res.status}. Intentando cach√© local.`);
      p = window.peliculasCache?.find(x => x._id === id);
      if (!p) throw new Error('Pel√≠cula no encontrada en backend ni en cach√©');
    }
    peliculaActual = p;

    // Rellenar datos en la secci√≥n Vender
    const img = document.getElementById('imgPelicula');
    const titulo = document.getElementById('tituloPelicula');
    const generoEl = document.querySelector('#seccionVender .info-pelicula .genero');
    const duracionEl = document.querySelector('#seccionVender .info-pelicula .duracion');
    const estrellaEl = document.querySelector('#seccionVender .info-pelicula .estrella');

    if (img) img.src = p.poster || '';
    if (titulo) titulo.textContent = p.titulo || '-';
    if (generoEl) generoEl.textContent = p.genero || '-';
    if (duracionEl) duracionEl.textContent = p.duracion || '-';
    if (estrellaEl) estrellaEl.textContent = p.calificacion ? `‚≠ê ${p.calificacion}` : '‚≠ê -';

    // Actualizar resumen lateral
    const resumenPelicula = document.getElementById('resumenPelicula');
    if (resumenPelicula) resumenPelicula.textContent = p.titulo || '-';

    // Mostrar la secci√≥n Vender y ocultar Cartelera
    document.getElementById('seccionCartelera').classList.add('oculto');
    const vender = document.getElementById('seccionVender');
    vender.classList.remove('oculto');
    vender.dataset.peliculaId = id;

    // Conectar bot√≥n "Seleccionar Asientos" de esta secci√≥n (selector espec√≠fico)
    const btnSeleccionar = document.querySelector('#seccionVender .opciones .acciones .continuar');
    if (btnSeleccionar) {
      btnSeleccionar.onclick = () => abrirAsientos();
    }

    // Bot√≥n volver dentro de Vender
    const btnVolver = document.getElementById('btnVolver');
    if (btnVolver) {
      btnVolver.onclick = () => {
        document.getElementById('seccionCartelera').classList.remove('oculto');
        vender.classList.add('oculto');
      };
    }

  } catch (err) {
    console.error('‚ùå Error cargando pel√≠cula:', err);
    // Intentar fallback con la cach√© global si existe
    const fallback = window.peliculasCache?.find(x => x._id === id);
    if (fallback) {
      console.warn('Usando fallback desde peliculasCache');
      peliculaActual = fallback;
      const img = document.getElementById('imgPelicula');
      const titulo = document.getElementById('tituloPelicula');
      const generoEl = document.querySelector('#seccionVender .info-pelicula .genero');
      const duracionEl = document.querySelector('#seccionVender .info-pelicula .duracion');
      const estrellaEl = document.querySelector('#seccionVender .info-pelicula .estrella');
      if (img) img.src = fallback.poster || '';
      if (titulo) titulo.textContent = fallback.titulo || '-';
      if (generoEl) generoEl.textContent = fallback.genero || '-';
      if (duracionEl) duracionEl.textContent = fallback.duracion || '-';
      if (estrellaEl) estrellaEl.textContent = fallback.calificacion ? `‚≠ê ${fallback.calificacion}` : '‚≠ê -';
      const resumenPelicula = document.getElementById('resumenPelicula');
      if (resumenPelicula) resumenPelicula.textContent = fallback.titulo || '-';
      document.getElementById('seccionCartelera').classList.add('oculto');
      const vender = document.getElementById('seccionVender');
      vender.classList.remove('oculto');
      vender.dataset.peliculaId = id;
      const btnSeleccionar = document.querySelector('#seccionVender .opciones .acciones .continuar');
      if (btnSeleccionar) btnSeleccionar.onclick = () => abrirAsientos();
      return;
    }

    alert('No se pudo cargar la informaci√≥n de la pel√≠cula. Revisa la consola para m√°s detalles.');
  }
}

function abrirAsientos() {
  // Mostrar secci√≥n de asientos
  document.getElementById('seccionVender').classList.add('oculto');
  const asientos = document.getElementById('seccionAsientos');
  asientos.classList.remove('oculto');

  // Rellenar t√≠tulo y resumen con la pel√≠cula actual
  const tituloAsientos = document.getElementById('tituloAsientos');
  if (tituloAsientos) tituloAsientos.textContent = peliculaActual?.titulo || '-';
  const resumenPelicula = document.getElementById('resumenPelicula');
  if (resumenPelicula) resumenPelicula.textContent = peliculaActual?.titulo || '-';

  // Conectar bot√≥n "volver" desde la vista de asientos para regresar a Vender
  const btnVolverAsientos = document.getElementById('btnVolverAsientos');
  if (btnVolverAsientos) {
    btnVolverAsientos.onclick = () => {
      asientos.classList.add('oculto');
      document.getElementById('seccionVender').classList.remove('oculto');
    };
  }
}
</script>
